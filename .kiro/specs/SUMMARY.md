# AAE 系统架构总结

## 🎯 核心理念

**一个入口，一个对话，多种能力**

用户通过 **User Portal** 访问系统，在主站内通过**嵌入式 AI Agent 对话界面**完成所有操作，无需切换不同工具或界面。

---

## 🏗️ 系统架构

```
用户
  │
  ▼
┌─────────────────────────────────────────┐
│         User Portal (用户入口)          │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │  Web 界面 (Next.js)             │   │
│  │  - Dashboard                    │   │
│  │  - 素材管理                     │   │
│  │  - 报表管理                     │   │
│  │  - 落地页管理                   │   │
│  │                                 │   │
│  │  ┌───────────────────────┐     │   │
│  │  │ AI Agent 对话窗口     │     │   │
│  │  │ (嵌入式，右下角)      │     │   │
│  │  │                       │     │   │
│  │  │ 用户: 帮我生成素材    │     │   │
│  │  │ AI: 好的！正在处理... │     │   │
│  │  └───────────────────────┘     │   │
│  └─────────────────────────────────┘   │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │  后端服务 (FastAPI)             │   │
│  │  - 用户认证                     │   │
│  │  - 数据管理                     │   │
│  │  - MCP Server                   │   │
│  │  - WebSocket Server             │   │
│  └─────────────────────────────────┘   │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │  数据存储                       │   │
│  │  - PostgreSQL + TimescaleDB     │   │
│  │  - Redis                        │   │
│  │  - AWS S3                       │   │
│  └─────────────────────────────────┘   │
└─────────────────────────────────────────┘
              │
              │ WebSocket (对话)
              │ MCP (数据访问)
              │
┌─────────────▼─────────────────────────┐
│      统一 AI Agent (独立服务)         │
│                                       │
│  ┌─────────────────────────────┐     │
│  │  对话理解与意图识别         │     │
│  │  (Gemini 2.5 Flash)         │     │
│  └─────────────────────────────┘     │
│              │                        │
│  ┌───────────▼─────────────┐         │
│  │  协调器 (Orchestrator)  │         │
│  └───────────┬─────────────┘         │
│              │                        │
│  ┌───────────▼─────────────┐         │
│  │    5 种能力模块          │         │
│  │                          │         │
│  │  - Creative Capability   │         │
│  │  - Market Intelligence   │         │
│  │  - Reporting Capability  │         │
│  │  - Landing Page          │         │
│  │  - Ad Engine             │         │
│  └──────────────────────────┘         │
└───────────────────────────────────────┘
```

---

## 📱 用户体验流程

### 1. 用户访问系统

```
1. 用户打开浏览器访问 User Portal
2. 登录后看到 Dashboard
3. 右下角有 AI Agent 对话图标 💬
```

### 2. 用户与 AI 对话

```
1. 点击对话图标，展开对话窗口
2. 输入："帮我生成素材并创建广告"
3. AI Agent 自动：
   - 识别意图
   - 调用 Creative Capability 生成素材
   - 调用 Ad Engine Capability 创建广告
   - 返回结果
4. 用户在同一对话中继续操作
```

### 3. 用户查看数据

```
1. 用户可以：
   - 在对话中查看数据（AI 返回图表和卡片）
   - 点击导航栏查看详细数据管理界面
2. 两种方式互补：
   - 对话：快速操作和查询
   - 界面：详细查看和管理
```

---

## 🔄 技术通信流程

### 前端 ↔ AI Agent（WebSocket）

```
User Portal 前端
    │
    │ WebSocket
    │ (实时对话)
    │
    ▼
统一 AI Agent
```

**消息格式**：
```json
// 用户消息
{
  "type": "user_message",
  "content": "帮我生成素材",
  "user_id": "user123",
  "session_id": "session456"
}

// AI 回复
{
  "type": "agent_message",
  "content": "好的！正在生成...",
  "streaming": true,
  "session_id": "session456"
}
```

### AI Agent ↔ User Portal（MCP）

```
统一 AI Agent
    │
    │ MCP Protocol
    │ (数据访问)
    │
    ▼
User Portal MCP Server
    │
    ▼
PostgreSQL + S3
```

**工具调用**：
```python
# AI Agent 调用 MCP 工具
result = await mcp_client.call_tool(
    "create_creative",
    {
        "user_id": "user123",
        "product_url": "https://...",
        "count": 10
    }
)
```

---

## 📊 模块职责

### User Portal

**作为用户入口**：
- ✅ 提供 Web 界面
- ✅ 嵌入 AI Agent 对话窗口
- ✅ WebSocket 实时通信
- ✅ 数据可视化（Dashboard、图表）

**作为数据平台**：
- ✅ 存储所有业务数据
- ✅ 提供 MCP Server
- ✅ 管理用户认证和权限
- ✅ 处理订阅和计费

### 统一 AI Agent

**作为智能助手**：
- ✅ 理解用户意图
- ✅ 协调能力模块
- ✅ 管理对话上下文
- ✅ 返回统一结果

**5 种能力模块**：
- ✅ Creative Capability（素材生成）
- ✅ Market Intelligence Capability（市场洞察）
- ✅ Reporting Capability（报表分析）
- ✅ Landing Page Capability（落地页生成）
- ✅ Ad Engine Capability（投放管理）

---

## 🎨 界面设计

### Dashboard 布局

```
┌─────────────────────────────────────────────────────────┐
│  AAE Dashboard                            [用户头像]     │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐             │
│  │今日花费  │  │  ROAS    │  │   CPA    │             │
│  │  $87.50  │  │   2.8    │  │  $15.20  │             │
│  └──────────┘  └──────────┘  └──────────┘             │
│                                                         │
│  ┌─────────────────────────────────────────────┐       │
│  │         近 7 天 ROAS 趋势图                 │       │
│  │                                              │       │
│  │         [折线图]                             │       │
│  └─────────────────────────────────────────────┘       │
│                                                         │
│  ┌─────────────────────────────────────────────┐       │
│  │  💡 AI 建议                                  │       │
│  │  - Adset "51-65 岁" 表现较差，建议暂停       │       │
│  │  - Adset "18-35 岁" 表现优秀，建议加预算     │       │
│  └─────────────────────────────────────────────┘       │
│                                                         │
│                                  ┌────────────────┐    │
│                                  │                │    │
│                                  │  AI Agent      │    │
│                                  │  对话窗口      │    │
│                                  │                │    │
│                                  │  用户: 帮我... │    │
│                                  │  AI: 好的...   │    │
│                                  │                │    │
│                                  │  [输入框]      │    │
│                                  └────────────────┘    │
│                                                         │
│                                  [💬 对话图标]          │
└─────────────────────────────────────────────────────────┘
```

### 对话窗口特性

1. **位置**：右下角，可展开/收起
2. **大小**：展开后约 400x600px
3. **功能**：
   - 流式显示（逐字显示）
   - 富文本支持（Markdown、代码块）
   - 嵌入图表和卡片
   - 快速操作按钮
   - 历史记录
4. **交互**：
   - 文本输入
   - 图片上传
   - 链接粘贴
   - 语音输入（可选）

---

## 🚀 开发优先级

### 第 1-2 周：User Portal 基础

- [ ] 用户认证系统
- [ ] Dashboard 基础界面
- [ ] 数据管理模块（素材、报表、落地页、投放）
- [ ] MCP Server 实现
- [ ] **嵌入式对话界面组件**
- [ ] **WebSocket Server**

### 第 3-6 周：统一 AI Agent

- [ ] 对话理解与意图识别
- [ ] 协调器（Orchestrator）
- [ ] MCP Client 实现
- [ ] WebSocket Client 实现
- [ ] 5 种能力模块框架

### 第 3-4 周：Creative Capability

- [ ] 素材生成功能
- [ ] 竞品分析功能
- [ ] 素材评分功能

### 第 5 周：Reporting Capability

- [ ] 数据抓取功能
- [ ] AI 分析功能
- [ ] 异常检测功能

### 第 6 周：Market Intelligence + Landing Page Capability

- [ ] 市场洞察功能
- [ ] 落地页生成功能

### 第 9-10 周：Ad Engine Capability

- [ ] 广告创建功能
- [ ] 预算优化功能
- [ ] 规则引擎

### 第 11-12 周：集成与优化

- [ ] 能力模块集成
- [ ] 协调器优化
- [ ] 性能优化
- [ ] 用户体验优化

---

## 📝 关键文档

1. [ARCHITECTURE.md](./ARCHITECTURE.md) - 完整系统架构
2. [README.md](./README.md) - 需求文档总览
3. [user-portal/requirements.md](./user-portal/requirements.md) - User Portal 需求
4. [unified-ai-agent/requirements.md](./unified-ai-agent/requirements.md) - 统一 AI Agent 需求

---

## ✅ 架构优势

1. **用户体验**：
   - ✅ 单一入口，无需切换
   - ✅ 对话式交互，降低学习成本
   - ✅ 实时响应，流畅体验

2. **技术架构**：
   - ✅ 前后端分离
   - ✅ 能力模块化，易于扩展
   - ✅ MCP 标准化通信
   - ✅ WebSocket 实时通信

3. **开发效率**：
   - ✅ 模块独立开发
   - ✅ 可并行开发
   - ✅ 易于测试和维护

4. **可扩展性**：
   - ✅ 新增能力模块无需改动前端
   - ✅ 支持能力模块热插拔
   - ✅ 支持多语言、多平台扩展

---

## 🗺️ 未来功能 Roadmap

### MVP 阶段不包含（已标记）

以下功能在 MVP 阶段明确不包含，将在后续版本中逐步实现：

| 功能 | 当前状态 | 计划阶段 | 备注 |
|------|---------|---------|------|
| 视频素材生成 | ❌ 不包含 | V2.0 | 需要更高的 AI 调用成本 |
| 在线素材编辑器 | ❌ 不包含 | V2.0 | 建议用户使用 Canva/Figma |
| Google Ads 集成 | ❌ 不包含 | V1.5 | 优先支持 Meta 和 TikTok |
| 多租户企业版 | ❌ 不包含 | V3.0 | 当前为单租户 SaaS |
| 白标方案 | ❌ 不包含 | V3.0 | 面向代理商的定制方案 |

### 计划中的功能增强

| 功能 | 目标版本 | 优先级 | 描述 |
|------|---------|--------|------|
| 语音对话 | V1.5 | Medium | 支持语音输入与 AI 对话 |
| 移动端 App | V2.0 | Medium | iOS/Android 原生应用 |
| Shopify 插件 | V1.5 | High | 一键安装到 Shopify 店铺 |
| 邮件通知 | V1.2 | High | 每日报告和异常邮件推送 |
| Webhook 集成 | V1.5 | Medium | 支持推送到用户自有系统 |
| 团队协作 | V2.0 | Medium | 多用户协作管理广告 |
| 高级 A/B 测试 | V2.0 | Medium | 多变量测试和自动优化 |

### 技术债务和优化

| 项目 | 目标版本 | 描述 |
|------|---------|------|
| AI 模型成本优化 | V1.2 | 引入模型路由，小任务用轻量模型 |
| 缓存策略优化 | V1.2 | 优化 Redis 缓存策略 |
| 监控告警完善 | V1.1 | 完善 Prometheus + Grafana 监控 |
| 性能压测 | V1.1 | 进行全链路压力测试 |
| 安全审计 | V1.1 | 第三方安全审计 |

---

**文档版本**：v2.1
**最后更新**：2024-11-27
**维护者**：AAE 开发团队
