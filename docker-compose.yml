version: '3.8'

# AAE Platform Docker Compose Configuration
# Supports both development and production environments via environment variables
#
# Development (default): docker-compose up -d
# Production: ENVIRONMENT=production docker-compose up -d
#
# Required environment variables for production:
# - MYSQL_ROOT_PASSWORD, MYSQL_PASSWORD, REDIS_PASSWORD
# - SECRET_KEY, TOKEN_ENCRYPTION_KEY, WEB_PLATFORM_SERVICE_TOKEN
# - GEMINI_API_KEY (or AWS credentials for Bedrock)

services:
  mysql:
    image: mysql:8.4
    container_name: aae-mysql${CONTAINER_SUFFIX:-}
    restart: ${RESTART_POLICY:-unless-stopped}
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpassword}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-aae_platform}
      MYSQL_USER: ${MYSQL_USER:-aae_user}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-aae_password}
    ports:
      - "${MYSQL_PORT:-3306}:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      # Uncomment for production initialization scripts
      # - ./scripts/mysql-init:/docker-entrypoint-initdb.d
    command: --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: ${MYSQL_START_PERIOD:-10s}
    networks:
      - aae-network

  redis:
    image: redis:7-alpine
    container_name: aae-redis${CONTAINER_SUFFIX:-}
    restart: ${RESTART_POLICY:-unless-stopped}
    # Use password in production, no password in development
    command: >
      sh -c "if [ -n \"${REDIS_PASSWORD:-}\" ]; then
        redis-server --requirepass ${REDIS_PASSWORD} --maxmemory 256mb --maxmemory-policy allkeys-lru;
      else
        redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru;
      fi"
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: |
        sh -c "if [ -n \"${REDIS_PASSWORD:-}\" ]; then
          redis-cli --no-auth-warning -a ${REDIS_PASSWORD} ping;
        else
          redis-cli ping;
        fi"
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - aae-network

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      args:
        - BUILD_ENV=${ENVIRONMENT:-development}
    container_name: aae-backend${CONTAINER_SUFFIX:-}
    restart: ${RESTART_POLICY:-unless-stopped}
    ports:
      - "${BACKEND_PORT:-8000}:8000"
    environment:
      # Application
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - DEBUG=${DEBUG:-false}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}

      # Database & Cache
      - DATABASE_URL=mysql+aiomysql://${MYSQL_USER:-aae_user}:${MYSQL_PASSWORD:-aae_password}@mysql:3306/${MYSQL_DATABASE:-aae_platform}
      - REDIS_URL=redis://${REDIS_PASSWORD:+:${REDIS_PASSWORD}@}redis:6379/0

      # Security
      - SECRET_KEY=${SECRET_KEY:-your-secret-key-change-in-production}
      - TOKEN_ENCRYPTION_KEY=${TOKEN_ENCRYPTION_KEY}

      # OAuth
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}

      # Payment
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}

      # GCS Configuration (primary storage)
      - GCS_PROJECT_ID=${GCS_PROJECT_ID}
      - GCS_CREDENTIALS_PATH=${GCS_CREDENTIALS_PATH}
      - GCS_BUCKET_CREATIVES=${GCS_BUCKET_CREATIVES:-aae-creatives}
      - GCS_BUCKET_LANDING_PAGES=${GCS_BUCKET_LANDING_PAGES:-aae-landing-pages}
      - GCS_BUCKET_EXPORTS=${GCS_BUCKET_EXPORTS:-aae-exports}
      - GCS_BUCKET_UPLOADS=${GCS_BUCKET_UPLOADS:-aae-user-uploads}
      - GCS_CDN_DOMAIN=${GCS_CDN_DOMAIN}

      # AWS Core Configuration (optional, for S3/Bedrock/SageMaker)
      - AWS_REGION=${AWS_REGION:-us-west-2}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_SESSION_TOKEN=${AWS_SESSION_TOKEN}

      # AWS S3 Configuration (alternative storage backend)
      - S3_BUCKET_CREATIVES=${S3_BUCKET_CREATIVES:-aae-creatives}
      - S3_BUCKET_LANDING_PAGES=${S3_BUCKET_LANDING_PAGES:-aae-landing-pages}
      - S3_BUCKET_EXPORTS=${S3_BUCKET_EXPORTS:-aae-exports}
      - S3_BUCKET_UPLOADS=${S3_BUCKET_UPLOADS:-aae-user-uploads}
      - CLOUDFRONT_DOMAIN=${CLOUDFRONT_DOMAIN}

      # AWS Bedrock Configuration (alternative LLM provider)
      - BEDROCK_REGION=${BEDROCK_REGION:-us-west-2}
      - BEDROCK_DEFAULT_MODEL=${BEDROCK_DEFAULT_MODEL:-global.anthropic.claude-sonnet-4-5-20250929-v1:0}
      - BEDROCK_TEMPERATURE=${BEDROCK_TEMPERATURE:-0.7}
      - BEDROCK_MAX_TOKENS=${BEDROCK_MAX_TOKENS:-4096}

      # AWS SageMaker Configuration (for custom models)
      - SAGEMAKER_REGION=${SAGEMAKER_REGION:-us-west-2}
      - SAGEMAKER_QWEN_IMAGE_ENDPOINT=${SAGEMAKER_QWEN_IMAGE_ENDPOINT}
      - SAGEMAKER_WAN_VIDEO_ENDPOINT=${SAGEMAKER_WAN_VIDEO_ENDPOINT}

      # Gemini API (primary AI provider)
      - GEMINI_API_KEY=${GEMINI_API_KEY}

      # Service Integration
      - AI_ORCHESTRATOR_URL=http://ai-orchestrator:8001
      - WEB_PLATFORM_SERVICE_TOKEN=${WEB_PLATFORM_SERVICE_TOKEN}

      # CORS
      - CORS_ORIGINS=${CORS_ORIGINS}
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: ${BACKEND_START_PERIOD:-10s}
    networks:
      - aae-network
    logging:
      driver: "json-file"
      options:
        max-size: "${LOG_MAX_SIZE:-50m}"
        max-file: "${LOG_MAX_FILES:-3}"

  ai-orchestrator:
    build:
      context: ./ai-orchestrator
      dockerfile: Dockerfile
      args:
        - BUILD_ENV=${ENVIRONMENT:-development}
    container_name: aae-ai-orchestrator${CONTAINER_SUFFIX:-}
    restart: ${RESTART_POLICY:-unless-stopped}
    ports:
      - "${AI_ORCHESTRATOR_PORT:-8001}:8001"
    environment:
      # Application Settings
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}

      # Gemini API Configuration (primary AI provider)
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GEMINI_MODEL_CHAT=${GEMINI_MODEL_CHAT:-gemini-2.5-flash}
      - GEMINI_MODEL_FAST=${GEMINI_MODEL_FAST:-gemini-2.5-flash}

      # AWS Core Configuration
      - AWS_REGION=${AWS_REGION:-us-west-2}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_SESSION_TOKEN=${AWS_SESSION_TOKEN}

      # AWS S3 Configuration
      - S3_BUCKET_CREATIVES=${S3_BUCKET_CREATIVES:-aae-creatives}
      - S3_BUCKET_LANDING_PAGES=${S3_BUCKET_LANDING_PAGES:-aae-landing-pages}
      - S3_BUCKET_EXPORTS=${S3_BUCKET_EXPORTS:-aae-exports}
      - S3_BUCKET_UPLOADS=${S3_BUCKET_UPLOADS:-aae-user-uploads}
      - CLOUDFRONT_DOMAIN=${CLOUDFRONT_DOMAIN}

      # AWS Bedrock Configuration
      - BEDROCK_REGION=${BEDROCK_REGION:-us-west-2}
      - BEDROCK_DEFAULT_MODEL=${BEDROCK_DEFAULT_MODEL:-global.anthropic.claude-sonnet-4-5-20250929-v1:0}
      - BEDROCK_TEMPERATURE=${BEDROCK_TEMPERATURE:-0.7}
      - BEDROCK_MAX_TOKENS=${BEDROCK_MAX_TOKENS:-4096}

      # AWS SageMaker Configuration
      - SAGEMAKER_REGION=${SAGEMAKER_REGION:-us-west-2}
      - SAGEMAKER_QWEN_IMAGE_ENDPOINT=${SAGEMAKER_QWEN_IMAGE_ENDPOINT}
      - SAGEMAKER_WAN_VIDEO_ENDPOINT=${SAGEMAKER_WAN_VIDEO_ENDPOINT}

      # Web Platform Connection
      - WEB_PLATFORM_URL=http://backend:8000
      - WEB_PLATFORM_SERVICE_TOKEN=${WEB_PLATFORM_SERVICE_TOKEN}

      # Redis Configuration
      - REDIS_URL=redis://${REDIS_PASSWORD:+:${REDIS_PASSWORD}@}redis:6379/3
    depends_on:
      redis:
        condition: service_healthy
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: ${AI_START_PERIOD:-10s}
    networks:
      - aae-network
    logging:
      driver: "json-file"
      options:
        max-size: "${LOG_MAX_SIZE:-50m}"
        max-file: "${LOG_MAX_FILES:-3}"

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: ${FRONTEND_TARGET:-development}
      args:
        - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://localhost:8000}
        - NEXT_PUBLIC_WS_URL=${NEXT_PUBLIC_WS_URL:-ws://localhost:8000}
    container_name: aae-frontend${CONTAINER_SUFFIX:-}
    restart: ${RESTART_POLICY:-unless-stopped}
    ports:
      - "${FRONTEND_PORT:-3000}:3000"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://localhost:8000}
      - NEXT_PUBLIC_WS_URL=${NEXT_PUBLIC_WS_URL:-ws://localhost:8000}
    depends_on:
      - backend
    networks:
      - aae-network
    logging:
      driver: "json-file"
      options:
        max-size: "${LOG_MAX_SIZE:-50m}"
        max-file: "${LOG_MAX_FILES:-3}"

  # Nginx reverse proxy (optional, enable for production)
  # Uncomment below and create nginx/nginx.conf for SSL termination and load balancing
  # nginx:
  #   image: nginx:alpine
  #   container_name: aae-nginx${CONTAINER_SUFFIX:-}
  #   restart: ${RESTART_POLICY:-unless-stopped}
  #   ports:
  #     - "80:80"
  #     - "443:443"
  #   volumes:
  #     - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
  #     - ./nginx/ssl:/etc/nginx/ssl:ro
  #     - nginx_cache:/var/cache/nginx
  #   depends_on:
  #     - backend
  #     - frontend
  #   networks:
  #     - aae-network
  #   logging:
  #     driver: "json-file"
  #     options:
  #       max-size: "${LOG_MAX_SIZE:-10m}"
  #       max-file: "${LOG_MAX_FILES:-3}"

volumes:
  mysql_data:
    driver: local
  redis_data:
    driver: local
  # Uncomment if using nginx
  # nginx_cache:
  #   driver: local

networks:
  aae-network:
    driver: bridge
